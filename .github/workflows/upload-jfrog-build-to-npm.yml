name: Publish JFrog build to PyPI

permissions:
  # This is required for requesting the OIDC token
  id-token: write

on:
  workflow_dispatch:
    inputs:
      version:
        type: string
        description: Build version
        required: true
      #use-test-pypi:
      #  type: boolean
      #  description: 'DEBUG: upload to test.pypi.org?'
      #  required: true
      #  default: false
  workflow_call:
    inputs:
      version:
        type: string
        description: Build version
        required: true
    secrets:
      # Just make all the secrets required to make things simpler...
      NPMRC:
        required: true

jobs:
  publish-jfrog-build-to-npm:
    runs-on: ubuntu-22.04
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
        ref: ${{ env.COMMIT_SHA_TO_BUILD_AND_TEST }}
        # We need the last tag before the ref, so we can relabel the version if needed
        fetch-depth: 0

    - name: Set up JFrog credentials
      uses: jfrog/setup-jfrog-cli@v4
      env:
        JF_URL: https://aerospike.jfrog.io
      with:
        oidc-provider-name: gh-aerospike-clients
        oidc-audience: aerospike/clients

    - uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.nodejs-tag[1] }}
        
    - name: npm rc
      run: echo "$NPMRC_OFF" | base64 --decode > ~/.npmrc  
      env:
        NPMRC: ${{ secrets.NPMRC_OFF }}

    #- name: npm login
    #  run: |
    #    npm login --registry=https://aerospike.jfrog.io/artifactory/api/npm/clients-npm-dev-local/ --auth-type=web

    - name: npm get registry
      run: |
        npm get registry

    - name: build pack
      run: |
        cat package.json
        npm version 6.0.3-dev.4 --no-git-tag-version
        ./scripts/build-c-client.sh;
        npm install;

    - name: npm rc
      run: echo "$NPMRC" | base64 --decode > ~/.npmrc  

    - name: npm get registry
      run: |
        npm get registry
    
    - name: npm login
      run: |
        npm login --registry=https://aerospike.jfrog.io/artifactory/api/npm/clients-npm-dev-local/ --auth-type=web

    - name: npm publish
      run: |
        npm publish --registry=https://aerospike.jfrog.io/artifactory/api/npm/clients-npm-dev-local/


    - name: npm install
      run: |
        npm install aerospike@6.0.3-dev.4

    #- name: Download JFrog build
    #  run: jf rt dl --build python-client/6.0.3-dev.1 ${{ vars.JFROG_REPO_NAME }}
    #- name: npm install from JFrog
    #  run: |
    #    jf npm-config --repo-deploy --repo-resolve clients-npm-dev-local
    #    jf npm install --build-name=nodejs-client --build-number=6.0.3-dev.4
    #    ls .


    #- run: npm ci
    #- run: npm publish --provenance --access public
    #  env:
    #    NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}